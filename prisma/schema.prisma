// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// 型
/*
    { name: "国内", slug: "domestic" },
    { name: "国際", slug: "international" },
    { name: "経済", slug: "economy" },
    { name: "エンタメ", slug: "entertainment" },
    { name: "スポーツ", slug: "sports" },
    { name: "IT", slug: "it" },
    { name: "科学", slug: "science" },
    { name: "ライフ", slug: "life" },
    { name: "地域", slug: "local" },
*/
enum ArticleCategory {
  DOMESTIC
  INTERNATIONAL
  ECONOMY
  ENTERTAINMENT
  SPORTS
  IT
  SCIENCE
  LIFE
  LOCAL
}

// ユーザーモデル
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String?   @unique
  name          String?
  bio           String?
  image         String?
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // リレーション
  articles      Article[]
  comments      Comment[]
  reactions     Reaction[]
  followers     Follow[]   @relation("Following")
  following     Follow[]   @relation("Follower")
  badges        UserBadge[]
  sessions      Session[]
  accounts      Account[]

  @@map("users")
}

// Better-Auth用のセッションモデル
model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Better-Auth用のアカウントモデル
model Account {
  id                String   @id @default(cuid())
  accountId         String
  providerId        String
  userId            String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope             String?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

// Better-Auth用の検証トークンモデル
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verifications")
}

// 記事モデル
model Article {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  excerpt     String?
  coverImage  String?
  published   Boolean  @default(false)
  viewCount   Int      @default(0)
  authorId    String
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  isAllowed   Boolean  @default(true)

  // 評価
  funnyScore      Float @default(0)
  realityScore    Float @default(0)
  creativityScore Float @default(0)

  // リレーション
  author       User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category     Category   @relation(fields: [categoryId], references: [id])
  tags         ArticleTag[]
  comments     Comment[]
  reactions    Reaction[]

  @@index([authorId])
  @@index([categoryId])
  @@index([published])
  @@index([createdAt])
  @@map("articles")
}

// カテゴリーモデル
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  icon        String?
  createdAt   DateTime  @default(now())

  // リレーション
  articles Article[]

  @@map("categories")
}

// タグモデル
model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())

  // リレーション
  articles ArticleTag[]

  @@map("tags")
}

// 記事とタグの中間テーブル
model ArticleTag {
  articleId String
  tagId     String
  createdAt DateTime @default(now())

  // リレーション
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
  @@map("article_tags")
}

// コメントモデル
model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  articleId String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([userId])
  @@map("comments")
}

// リアクションモデル
model Reaction {
  id        String       @id @default(cuid())
  type      ReactionType
  articleId String
  userId    String
  createdAt DateTime     @default(now())

  // リレーション
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId, type])
  @@index([articleId])
  @@index([userId])
  @@map("reactions")
}

// リアクションの種類
enum ReactionType {
  BELIEVED    // 信じた
  LAUGHED     // 笑った
  THOUGHTFUL  // 考えさせられた
  MASTERPIECE // 傑作
}

// フォローモデル
model Follow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  // リレーション
  follower  User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

// バッジモデル
model Badge {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String
  createdAt   DateTime @default(now())

  // リレーション
  users UserBadge[]

  @@map("badges")
}

// ユーザーとバッジの中間テーブル
model UserBadge {
  userId    String
  badgeId   String
  createdAt DateTime @default(now())

  // リレーション
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@map("user_badges")
}
